name: Release Chromium Extension

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to publish (example: v1.2.3)"
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release tag
        id: tag
        env:
          INPUT_TAG_NAME: ${{ inputs.tag_name }}
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            TAG_NAME="${INPUT_TAG_NAME}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi

          if [ -z "${TAG_NAME}" ]; then
            echo "Tag name is required." >&2
            exit 1
          fi

          echo "tag_name=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Validate manifest
        run: |
          test -f src/manifest.json
          jq -e '.manifest_version == 3' src/manifest.json > /dev/null

      - name: Create release package
        run: |
          rm -rf dist
          mkdir -p dist/unpacked
          cp -R src/. dist/unpacked/
          cd dist/unpacked
          zip -r -9 "../chromium-extension-${{ steps.tag.outputs.tag_name }}.zip" .

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Chromium Extension ${{ steps.tag.outputs.tag_name }}
          generate_release_notes: true
          files: dist/chromium-extension-${{ steps.tag.outputs.tag_name }}.zip
