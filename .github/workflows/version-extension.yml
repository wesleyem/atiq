name: Version Chromium Extension

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/version-extension.yml"
      - ".github/workflows/release-extension.yml"
  workflow_dispatch:
    inputs:
      bump:
        description: "Optional bump override"
        required: false
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
        default: auto

concurrency:
  group: version-extension-main
  cancel-in-progress: false

jobs:
  version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: bump
        env:
          INPUT_BUMP: ${{ inputs.bump }}
        run: |
          set -euo pipefail

          git fetch --tags --force

          LAST_TAG="$(git tag --list 'v*' --sort=-v:refname | head -n 1)"
          if [ -z "${LAST_TAG}" ]; then
            LAST_TAG="v0.0.0"
            RANGE="HEAD"
          else
            RANGE="${LAST_TAG}..HEAD"
          fi

          SUBJECTS="$(git log --format='%s' ${RANGE})"
          BODIES="$(git log --format='%b' ${RANGE})"

          BUMP="${INPUT_BUMP:-auto}"
          if [ -z "${BUMP}" ] || [ "${BUMP}" = "auto" ]; then
            if echo "${SUBJECTS}" | grep -Eq '^[a-zA-Z]+(\([^)]+\))?!:' || echo "${BODIES}" | grep -Eq 'BREAKING CHANGE:'; then
              BUMP="major"
            elif echo "${SUBJECTS}" | grep -Eq '^feat(\([^)]+\))?:'; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi

          CURRENT="${LAST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "${CURRENT}"

          case "${BUMP}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "Unsupported bump type: ${BUMP}" >&2
              exit 1
              ;;
          esac

          NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          NEXT_TAG="v${NEXT_VERSION}"

          if git rev-parse -q --verify "refs/tags/${NEXT_TAG}" >/dev/null; then
            echo "Tag ${NEXT_TAG} already exists; skipping." >&2
            exit 1
          fi

          echo "last_tag=${LAST_TAG}" >> "${GITHUB_OUTPUT}"
          echo "range=${RANGE}" >> "${GITHUB_OUTPUT}"
          echo "bump=${BUMP}" >> "${GITHUB_OUTPUT}"
          echo "next_version=${NEXT_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "next_tag=${NEXT_TAG}" >> "${GITHUB_OUTPUT}"

      - name: Update manifest version
        run: |
          set -euo pipefail
          test -f src/manifest.json
          TMP_FILE="$(mktemp)"
          jq --arg version "${{ steps.bump.outputs.next_version }}" '.version = $version' src/manifest.json > "${TMP_FILE}"
          mv "${TMP_FILE}" src/manifest.json

      - name: Commit version and tag
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add src/manifest.json
          git commit -m "chore(release): ${{ steps.bump.outputs.next_tag }} [skip ci]"
          git tag "${{ steps.bump.outputs.next_tag }}"

          git push origin "HEAD:${GITHUB_REF_NAME}"
          git push origin "${{ steps.bump.outputs.next_tag }}"
